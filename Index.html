<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RifaManager Pro - Sistema Completo de Rifas</title>
    <link rel="stylesheet" href="style.css" type="text/css">
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="logo"><img src="./RIFASCOL.jpg" width="100px" height="100px"></img></div>
            <!-- <h1>RIFASCOL</h1> -->
            <p style="font-size: 1.2em; opacity: 0.9;">Manejo de Rifas - ¬©RIFASCOL</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <div class="input-group">
                    <label for="listaRifas">üìã Rifas existentes:</label>
                    <div class="combo-container">
                        <select id="listaRifas" onchange="cargarRifaSeleccionada()">
                            <option value="">-- Nueva Rifa --</option>
                            <!-- Las opciones se llenar√°n din√°micamente -->
                        </select>
                        <button class="delete-rifa-btn" onclick="eliminarRifaActual()" title="Eliminar rifa">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>

                <div class="input-group">
                    <label for="nombreLoteria">üèõÔ∏è Juega Con:</label>
                    <input type="text" id="nombreLoteria" placeholder="Ej: Loter√≠a de Bogot√°" required>
                </div>
                <div class="input-group">
                    <label for="premio">üèÜ Premio de la Rifa:</label>
                    <input type="text" id="premio" placeholder="Ej: iPhone 15 Pro Max">
                </div>
            </div>

            <div class="control-group">
                <div class="input-group">
                    <label for="precio">üí∞ Precio por N√∫mero:</label>
                    <input type="number" id="precio" placeholder="Ej: 5000" step="100">
                </div>
                <div class="input-group">
                    <label for="fechaSorteo">üìÖ Fecha del Sorteo:</label>
                    <input type="datetime-local" id="fechaSorteo">
                </div>
                <div class="input-group">
                    <label for="reglasRifa">üìú Reglas de la Rifa:</label>
                    <textarea id="reglasRifa" rows="3"
                        placeholder="Ej: Se puede ganar con los dos primeros n√∫meros, con los √∫ltimos invertidos, etc."></textarea>
                </div>
            </div>

            <div class="control-group">
                <button class="btn btn-primary" onclick="inicializarRifa()">üöÄ Inicializar/Actualizar Rifa</button>
                <button class="btn btn-success" onclick="guardarNumeros()" id="btnGuardarNumeros" disabled>üíæ Guardar
                    N√∫meros</button>
                <button class="btn btn-primary" onclick="exportarPNG()" id="btnExportarPNG" disabled>üñºÔ∏è Exportar Imagen
                    PNG</button>
                <button class="btn btn-warning" onclick="limpiarTodoFirebase()">üßπ Limpiar Todo</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3 id="totalNumerosDisplay">0</h3>
                <p>Total N√∫meros</p>
            </div>
            <div class="stat-card">
                <h3 id="numerosVendidos">0</h3>
                <p>N√∫meros Vendidos</p>
            </div>
            <div class="stat-card">
                <h3 id="numerosDisponibles">0</h3>
                <p>N√∫meros Disponibles</p>
            </div>
            <div class="stat-card">
                <h3 id="totalRecaudado">$0</h3>
                <p>Total Recaudado</p>
            </div>
        </div>

        <div class="rifa-grid" id="rifaGridSection" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 25px; color: #2d5016; font-size: 2em;">üé≤ N√∫meros de la Rifa
            </h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <p style="text-align: center; margin-bottom: 25px; color: #2d5016; font-size: 1.2em; font-weight: 600;">
                Progreso de Ventas: <span id="porcentajeVentas">0%</span>
            </p>
            <div class="grid-container" id="gridContainer">
                <!-- Los n√∫meros se generan aqu√≠ din√°micamente -->
            </div>
        </div>

        <div class="export-section" id="exportSection" style="display: none;">
            <div class="control-group">
                <!-- Tus otros botones existentes -->
                <button class="btn btn-success" onclick="mostrarModalGanador()">üèÜ Felicitar Ganador</button>
            </div>
        </div>
    </div>

    <!-- Modal para vender n√∫mero -->
    <div id="ventaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <h2>üé´ Vender N√∫mero <span id="numeroSeleccionado"></span></h2>
            <div class="input-group">
                <label for="nombreComprador">üë§ Nombre del Comprador:</label>
                <input type="text" id="nombreComprador" placeholder="Nombre completo">
            </div>
            <div class="input-group">
                <label for="telefonoComprador">üì± Tel√©fono:</label>
                <input type="tel" id="telefonoComprador" placeholder="Ej: 300 123 4567">
            </div>
            <div class="input-group">
                <label for="emailComprador">üìß Email (opcional):</label>
                <input type="email" id="emailComprador" placeholder="email@ejemplo.com">
            </div>
            <div class="input-group">
                <label for="notasComprador">üìù Notas adicionales:</label>
                <textarea id="notasComprador" rows="3" placeholder="Informaci√≥n adicional..."></textarea>
            </div>
            <br>
            <div style="text-align: center;">
                <button class="btn btn-success" onclick="confirmarVenta()">‚úÖ Confirmar</button>
                <button class="btn btn-warning" onclick="cerrarModal()" style="margin-left: 15px;">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para ver detalles -->
    <div id="detallesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalDetalles()">&times;</span>
            <h2>üìã Detalles del N√∫mero <span id="numeroDetalles"></span></h2>
            <div id="infoComprador">
                <!-- Se llena din√°micamente -->
            </div>
            <br>
            <div style="text-align: center;">
                <button class="btn btn-warning" onclick="liberarNumero()" id="btnLiberar">üîì Liberar N√∫mero</button>
                <button class="btn btn-primary" onclick="cerrarModalDetalles()" style="margin-left: 15px;">‚úÖ
                    Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para felicitar al ganador -->
    <div id="ganadorModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
            <span class="close" onclick="cerrarModalGanador()">&times;</span>
            <h2>üèÜ Felicitar al Ganador</h2>

            <!-- Contenedor con scroll -->
            <div style="overflow-y: auto; flex: 1; padding-right: 10px;">
                <div class="input-group">
                    <label for="numeroGanador">üî¢ N√∫mero Ganador (00-99):</label>
                    <input type="number" id="numeroGanador" min="0" max="99" placeholder="Ej: 05">
                </div>

                <div class="input-group">
                    <label for="valorPremio">üí∞ Valor del Premio:</label>
                    <input type="text" id="valorPremio" placeholder="Ej: $5.000.000">
                </div>

                <div class="input-group">
                    <label for="numeroLoteriaJugado">üî¢ N√∫mero Jugado:</label>
                    <input type="text" id="numeroLoteriaJugado" placeholder="Ej: 1456">
                </div>

                <div class="input-group">
                    <label for="comprobantePago">üìé Comprobante de Pago (opcional):</label>
                    <input type="file" id="comprobantePago" accept="image/*">
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generarPlantillaGanador()">üñºÔ∏è Generar Plantilla</button>
                </div>

                <!-- Contenedor para previsualizaci√≥n -->
                <div id="previewPlantilla" style="margin-top: 30px; display: none;">
                    <h3>üìù Vista Previa</h3>
                    <div id="plantillaGanador"
                        style="background: white; padding: 20px; border-radius: 15px; text-align: center;">
                        <!-- Aqu√≠ se generar√° la plantilla -->
                    </div>
                    <button class="btn btn-success" onclick="exportarPlantillaPNG()" style="margin-top: 15px;">üì§
                        Exportar PNG</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCLW7Yslz-YxlZFUGM1atBnGiS9t0kKZ3s",
            authDomain: "rifascol-48a79.firebaseapp.com",
            databaseURL: "https://rifascol-48a79-default-rtdb.firebaseio.com",
            projectId: "rifascol-48a79",
            storageBucket: "rifascol-48a79.firebasestorage.app",
            messagingSenderId: "845507430054",
            appId: "1:845507430054:web:96c5c726c98c2fe0b8d667",
            measurementId: "G-4X9LYJH9XB"
        };

        // Inicializa Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Variables globales - INICIALIZADAS AL PRINCIPIO
        let rifaData = {
            totalNumeros: 100,
            premio: '',
            precio: 0,
            fechaSorteo: '',
            reglas: '',
            numeros: {},
            inicializada: false,
            nombreLoteria: ''
        };

        let rifaActualNombre = ''; // Inicializada expl√≠citamente
        let numeroSeleccionado = null;


        // Funci√≥n para escuchar cambios en tiempo real
        function configurarListenerRifa() {
            if (!rifaActualNombre) return;

            let ultimosNumeros = JSON.stringify(rifaData.numeros || {});
            let ultimaFecha = rifaData.fechaSorteo;

            database.ref('rifas/' + rifaActualNombre).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const nuevosNumeros = JSON.stringify(data.numeros || {});

                    // Solo actualizar si cambian los n√∫meros
                    if (nuevosNumeros !== ultimosNumeros) {
                        rifaData = data;
                        ultimosNumeros = nuevosNumeros;
                        generarGrid();
                        actualizarEstadisticas();
                        mostrarNotificacion('üîî Se actualizaron los n√∫meros de la rifa');
                    }
                    // Actualizar otros datos sin notificaci√≥n
                    else if (data.fechaSorteo !== ultimaFecha) {
                        rifaData.fechaSorteo = data.fechaSorteo;
                        ultimaFecha = data.fechaSorteo;
                        document.getElementById('fechaSorteo').value = data.fechaSorteo || '';
                    }
                }
            });
        }

        // ================= FUNCIONES PRINCIPALES =================
        function inicializarRifa() {
            const nombreLoteriaInput = document.getElementById('nombreLoteria');
            const nombreLoteria = nombreLoteriaInput.value.trim();
            const rifaSeleccionada = document.getElementById('listaRifas').value;

            if (!nombreLoteria) {
                mostrarNotificacion('‚ö†Ô∏è Ingresa un nombre para la loter√≠a', 'warning');
                nombreLoteriaInput.focus();
                return;
            }

            // Determinar si es una rifa nueva o actualizaci√≥n de una existente
            const esRifaNueva = rifaSeleccionada === '' || rifaSeleccionada === null;
            const nuevoNombreRifa = nombreLoteria.replace(/\//g, '-');

            if (esRifaNueva) {
                // Es una rifa completamente nueva - verificar si ya existe
                database.ref('rifas/' + nuevoNombreRifa).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            // El nombre ya existe y es una rifa nueva
                            if (!confirm(`¬øYa existe una rifa llamada "${nombreLoteria}". ¬øDeseas actualizarla?`)) {
                                return;
                            }
                        }

                        // Proceder con la creaci√≥n/actualizaci√≥n
                        crearOActualizarRifa(nuevoNombreRifa, nombreLoteria, snapshot.exists());
                    })
                    .catch(error => {
                        console.error("Error al verificar rifa:", error);
                        mostrarNotificacion('‚ö†Ô∏è Error al verificar la rifa', 'warning');
                    });
            } else {
                // Es actualizaci√≥n de una rifa existente
                // Verificar si el nuevo nombre es diferente al actual
                if (nuevoNombreRifa !== rifaSeleccionada) {
                    // El usuario est√° cambiando el nombre de la rifa existente
                    // Verificar si el nuevo nombre ya existe (y es diferente a la actual)
                    database.ref('rifas/' + nuevoNombreRifa).once('value')
                        .then((snapshot) => {
                            if (snapshot.exists() && nuevoNombreRifa !== rifaSeleccionada) {
                                mostrarNotificacion(`‚ö†Ô∏è Ya existe otra rifa con el nombre "${nombreLoteria}". Elige un nombre diferente.`, 'warning');
                                return;
                            }

                            // Cambiar el nombre de la rifa existente
                            cambiarNombreRifa(rifaSeleccionada, nuevoNombreRifa, nombreLoteria);
                        })
                        .catch(error => {
                            console.error("Error al verificar nuevo nombre:", error);
                            mostrarNotificacion('‚ö†Ô∏è Error al verificar el nuevo nombre', 'warning');
                        });
                } else {
                    // Mismo nombre, solo actualizar datos
                    actualizarDatosRifa(rifaSeleccionada, nombreLoteria);
                }
            }
        }

        function crearOActualizarRifa(nombreRifaKey, nombreLoteria, yaExiste) {
            // Asignar el nombre de la rifa
            rifaActualNombre = nombreRifaKey;

            // Si existe, cargar los datos existentes primero
            if (yaExiste) {
                database.ref('rifas/' + nombreRifaKey).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            rifaData = snapshot.val();
                        }

                        // Actualizar los campos
                        actualizarCamposRifa(nombreLoteria);

                        return guardarRifaEnFirebase();
                    })
                    .then(() => {
                        finalizarInicializacion(nombreLoteria, 'actualizada');
                    })
                    .catch(error => {
                        console.error("Error al actualizar:", error);
                        mostrarNotificacion('‚ö†Ô∏è Error al actualizar la rifa', 'warning');
                        resetearEstado();
                    });
            } else {
                // Crear nueva rifa
                inicializarNuevaRifa(nombreLoteria);
                actualizarCamposRifa(nombreLoteria);

                guardarRifaEnFirebase()
                    .then(() => {
                        finalizarInicializacion(nombreLoteria, 'creada');
                    })
                    .catch(error => {
                        console.error("Error al crear:", error);
                        mostrarNotificacion('‚ö†Ô∏è Error al crear la rifa', 'warning');
                        resetearEstado();
                    });
            }
        }

        function cambiarNombreRifa(nombreAnterior, nuevoNombreKey, nombreLoteria) {
            // Obtener los datos de la rifa anterior
            database.ref('rifas/' + nombreAnterior).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        mostrarNotificacion('‚ö†Ô∏è Error: la rifa anterior no existe', 'warning');
                        return;
                    }

                    const datosAnteriores = snapshot.val();

                    // Actualizar los campos con los nuevos valores
                    datosAnteriores.nombreLoteria = nombreLoteria;
                    datosAnteriores.premio = document.getElementById('premio').value.trim();
                    datosAnteriores.precio = parseFloat(document.getElementById('precio').value) || 0;
                    datosAnteriores.fechaSorteo = document.getElementById('fechaSorteo').value;
                    datosAnteriores.reglas = document.getElementById('reglasRifa').value.trim();

                    // Crear la nueva rifa con el nuevo nombre
                    return database.ref('rifas/' + nuevoNombreKey).set(datosAnteriores);
                })
                .then(() => {
                    // Eliminar la rifa anterior
                    return database.ref('rifas/' + nombreAnterior).remove();
                })
                .then(() => {
                    // Actualizar la rifa activa
                    return database.ref('rifaActiva').set(nuevoNombreKey);
                })
                .then(() => {
                    // Actualizar variables globales
                    rifaActualNombre = nuevoNombreKey;
                    rifaData.nombreLoteria = nombreLoteria;

                    // Actualizar la interfaz
                    return listarRifas().then(() => {
                        document.getElementById('listaRifas').value = nuevoNombreKey;
                        configurarListenerRifa();
                    });
                })
                .then(() => {
                    mostrarNotificacion(`üîÑ Rifa renombrada exitosamente a "${nombreLoteria}"`);
                    finalizarInicializacion(nombreLoteria, 'actualizada');
                })
                .catch(error => {
                    console.error("Error al cambiar nombre:", error);
                    mostrarNotificacion('‚ö†Ô∏è Error al cambiar el nombre de la rifa', 'warning');
                });
        }

        function actualizarDatosRifa(nombreRifa, nombreLoteria) {
            // Solo actualizar los campos, mantener el mismo nombre de rifa
            actualizarCamposRifa(nombreLoteria);

            guardarRifaEnFirebase()
                .then(() => {
                    mostrarNotificacion(`üìù Datos de la rifa "${nombreLoteria}" actualizados`);
                })
                .catch(error => {
                    console.error("Error al actualizar datos:", error);
                    mostrarNotificacion('‚ö†Ô∏è Error al actualizar los datos', 'warning');
                });
        }

        function inicializarNuevaRifa(nombreLoteria) {
            rifaData = {
                totalNumeros: 100,
                premio: '',
                precio: 0,
                fechaSorteo: '',
                reglas: '',
                numeros: {},
                inicializada: true,
                nombreLoteria: nombreLoteria
            };

            // Inicializar n√∫meros
            for (let i = 0; i < rifaData.totalNumeros; i++) {
                rifaData.numeros[i] = {
                    estado: 'disponible',
                    comprador: null
                };
            }
        }

        function actualizarCamposRifa(nombreLoteria) {
            rifaData.nombreLoteria = nombreLoteria;
            rifaData.premio = document.getElementById('premio').value.trim();
            rifaData.precio = parseFloat(document.getElementById('precio').value) || 0;
            rifaData.fechaSorteo = document.getElementById('fechaSorteo').value;
            rifaData.reglas = document.getElementById('reglasRifa').value.trim();
            rifaData.inicializada = true;
        }

        function finalizarInicializacion(nombreLoteria, accion) {
            document.getElementById('rifaGridSection').style.display = 'block';
            document.getElementById('exportSection').style.display = 'block';
            document.getElementById('btnGuardarNumeros').disabled = false;
            document.getElementById('btnExportarPNG').disabled = false;

            // Mostrar bot√≥n de eliminar
            document.querySelector('.delete-rifa-btn').style.display = 'block';

            generarGrid();
            actualizarEstadisticas();
            configurarListenerRifa();

            mostrarNotificacion(`üéâ Rifa "${nombreLoteria}" ${accion} correctamente!`);
        }

        function resetearEstado() {
            rifaActualNombre = '';
            rifaData.inicializada = false;
        }

        function guardarRifaEnFirebase() {
            return new Promise((resolve, reject) => {
                if (!rifaData.inicializada || !rifaActualNombre) {
                    reject("Datos de rifa no v√°lidos");
                    return;
                }

                // Asegurarse de que las reglas est√°n actualizadas
                rifaData.reglas = document.getElementById('reglasRifa').value.trim();

                database.ref('rifas/' + rifaActualNombre).set(rifaData)
                    .then(() => {
                        return database.ref('rifaActiva').set(rifaActualNombre);
                    })
                    .then(() => {
                        // Actualizar el dropdown y seleccionar la rifa actual
                        return listarRifas().then(() => {
                            document.getElementById('listaRifas').value = rifaActualNombre;
                            const deleteBtn = document.querySelector('.delete-rifa-btn');
                            deleteBtn.style.display = 'block';
                        });
                    })
                    .then(() => resolve())
                    .catch(error => {
                        console.error("Error al guardar:", error);
                        reject(error);
                    });
            });
        }

        // Modifica listarRifas para que devuelva una Promise
        function listarRifas() {
            return database.ref('rifas').once('value')
                .then((snapshot) => {
                    const select = document.getElementById('listaRifas');
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- Nueva Rifa --</option>';

                    snapshot.forEach((childSnapshot) => {
                        const option = document.createElement('option');
                        option.value = childSnapshot.key;
                        option.textContent = childSnapshot.key;
                        option.setAttribute('data-rifa-id', childSnapshot.key);
                        select.appendChild(option);
                    });

                    // Restaurar la selecci√≥n actual si existe
                    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                        select.value = currentValue;
                    }

                    // Mostrar u ocultar bot√≥n seg√∫n selecci√≥n
                    const deleteBtn = document.querySelector('.delete-rifa-btn');
                    deleteBtn.style.display = select.value ? 'block' : 'none';
                });
        }

        function cargarRifaSeleccionada() {
            const rifaNombre = document.getElementById('listaRifas').value;
            if (!rifaNombre) {
                limpiarLocal();
                return;
            }

            // Desconectar listener anterior si existe
            if (rifaActualNombre) {
                database.ref('rifas/' + rifaActualNombre).off();
            }

            database.ref('rifas/' + rifaNombre).once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        rifaData = data;
                        rifaActualNombre = rifaNombre;

                        // Actualizar TODOS los campos del formulario
                        document.getElementById('nombreLoteria').value = rifaData.nombreLoteria || '';
                        document.getElementById('premio').value = rifaData.premio || '';
                        document.getElementById('precio').value = rifaData.precio || '';
                        document.getElementById('fechaSorteo').value = rifaData.fechaSorteo || '';
                        document.getElementById('reglasRifa').value = rifaData.reglas || ''; // Nuevo campo de reglas

                        // Mostrar bot√≥n de eliminar
                        document.querySelector('.delete-rifa-btn').style.display = 'block';

                        // Configurar listener en tiempo real
                        configurarListenerRifa();

                        // Mostrar la interfaz
                        if (rifaData.inicializada) {
                            document.getElementById('rifaGridSection').style.display = 'block';
                            document.getElementById('exportSection').style.display = 'block';
                            document.getElementById('btnGuardarNumeros').disabled = false;
                            document.getElementById('btnExportarPNG').disabled = false;
                            generarGrid();
                            actualizarEstadisticas();
                        }

                        mostrarNotificacion(`üîÅ Rifa "${rifaNombre}" cargada`);
                    }
                })
                .catch(error => {
                    console.error("Error al cargar:", error);
                    mostrarNotificacion('‚ö†Ô∏è Error al cargar la rifa', 'warning');

                    // Restablecer valores en caso de error
                    limpiarLocal();
                });
        }
        // ================= FUNCIONES AUXILIARES =================

        function eliminarRifaActual() {
            if (!rifaActualNombre) {
                mostrarNotificacion('‚ÑπÔ∏è No hay rifa seleccionada', 'info');
                return;
            }

            if (confirm(`¬øEliminar la rifa "${rifaActualNombre}"?`)) {
                database.ref('rifas/' + rifaActualNombre).remove()
                    .then(() => {
                        // Verificar si era la rifa activa
                        database.ref('rifaActiva').once('value')
                            .then((snapshot) => {
                                if (snapshot.val() === rifaActualNombre) {
                                    return database.ref('rifaActiva').remove();
                                }
                            })
                            .then(() => {
                                mostrarNotificacion(`üóëÔ∏è Rifa eliminada`);
                                limpiarLocal();
                                listarRifas();
                            });
                    })
                    .catch(error => {
                        console.error("Error al eliminar:", error);
                        mostrarNotificacion('‚ö†Ô∏è Error al eliminar', 'warning');
                    });
            }
        }

        function limpiarTodoFirebase() {
            if (confirm('‚ö†Ô∏è ¬øEliminar TODAS las rifas?')) {
                database.ref('rifas').remove()
                    .then(() => database.ref('rifaActiva').remove())
                    .then(() => {
                        mostrarNotificacion('üî• Todas las rifas eliminadas');
                        limpiarLocal();
                        listarRifas();
                    })
                    .catch(error => {
                        console.error("Error al limpiar:", error);
                        mostrarNotificacion('‚ö†Ô∏è Error al limpiar', 'warning');
                    });
            }
        }

        // ================= INICIALIZACI√ìN =================

        document.addEventListener('DOMContentLoaded', function () {
            // Cargar rifas disponibles
            listarRifas();

            // Verificar si hay una rifa activa
            database.ref('rifaActiva').once('value')
                .then((snapshot) => {
                    const rifaActiva = snapshot.val();
                    if (rifaActiva) cargarRifaSeleccionada(rifaActiva);
                });

            // Configurar eventos
            document.getElementById('ventaModal').addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                    confirmarVenta();
                }
            });

            const telefonoInput = document.getElementById('telefonoComprador');

            if (telefonoInput) {
                // Validar mientras escribe
                telefonoInput.addEventListener('input', function () {
                    validarTelefonoInput(this);
                });

                // Formatear al salir del campo
                telefonoInput.addEventListener('blur', function () {
                    const telefonoFormateado = formatearTelefono(this.value);
                    if (telefonoFormateado) {
                        this.value = telefonoFormateado;
                    }
                });

                // Permitir solo n√∫meros, espacios y el s√≠mbolo +
                telefonoInput.addEventListener('keypress', function (e) {
                    const char = String.fromCharCode(e.which);
                    if (!/[\d\s+]/.test(char)) {
                        e.preventDefault();
                    }
                });

                // Agregar placeholder y maxlength
                telefonoInput.placeholder = "Ej: +57 300 210 4088 o 3002104088";
                telefonoInput.maxLength = "20"; // Permitir formato con espacios y +57
            }
        });

        // ================= FUNCIONES PRINCIPALES =================

        function limpiarLocal() {
            // Desconectar listener si existe
            if (rifaActualNombre) {
                database.ref('rifas/' + rifaActualNombre).off();
            }

            rifaData = {
                totalNumeros: 100,
                premio: '',
                precio: 0,
                fechaSorteo: '',
                reglas: '',
                numeros: {},
                inicializada: false,
                nombreLoteria: ''
            };
            rifaActualNombre = '';

            // Resto del c√≥digo de limpieza...
            document.getElementById('nombreLoteria').value = '';
            document.getElementById('premio').value = '';
            document.getElementById('precio').value = '';
            document.getElementById('fechaSorteo').value = '';
            document.getElementById('reglasRifa').value = '';
            document.getElementById('listaRifas').value = '';

            document.getElementById('rifaGridSection').style.display = 'none';
            document.getElementById('exportSection').style.display = 'none';
            document.getElementById('btnGuardarNumeros').disabled = true;
            document.getElementById('btnExportarPNG').disabled = true;

            if (document.getElementById('gridContainer')) {
                document.getElementById('gridContainer').innerHTML = '';
            }

            actualizarEstadisticas();
        }

        // ================= FUNCIONES DE RIFA =================

        function generarGrid() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';

            for (let i = 0; i < rifaData.totalNumeros; i++) {
                const numeroDiv = document.createElement('div');
                numeroDiv.className = `numero ${rifaData.numeros[i].estado}`;
                numeroDiv.textContent = i.toString().padStart(2, '0');
                numeroDiv.onclick = () => clickNumero(i);
                container.appendChild(numeroDiv);
            }
        }

        function clickNumero(numero) {
            if (!rifaData.inicializada) {
                mostrarNotificacion('‚ö†Ô∏è Primero debes inicializar la rifa', 'warning');
                return;
            }

            if (rifaData.numeros[numero].estado === 'disponible') {
                numeroSeleccionado = numero;
                document.getElementById('numeroSeleccionado').textContent = numero.toString().padStart(2, '0');
                document.getElementById('ventaModal').style.display = 'block';
                document.getElementById('nombreComprador').value = '';
                document.getElementById('telefonoComprador').value = '';
                document.getElementById('emailComprador').value = '';
                document.getElementById('notasComprador').value = '';
                document.getElementById('nombreComprador').focus();
            } else {
                mostrarDetalles(numero);
            }
        }

        // Funci√≥n para formatear n√∫mero de tel√©fono
        function formatearTelefono(telefono) {
            // Remover todo excepto n√∫meros
            let numeroLimpio = telefono.replace(/\D/g, '');

            // Si empieza con 57 (c√≥digo de Colombia), removerlo
            if (numeroLimpio.startsWith('57') && numeroLimpio.length === 12) {
                numeroLimpio = numeroLimpio.substring(2);
            }

            // Validar que tenga exactamente 10 d√≠gitos
            if (numeroLimpio.length !== 10) {
                return null; // N√∫mero inv√°lido
            }

            // Validar que empiece con 3 (n√∫meros m√≥viles colombianos)
            if (!numeroLimpio.startsWith('3')) {
                return null; // No es un n√∫mero m√≥vil v√°lido
            }

            return numeroLimpio;
        }

        // Funci√≥n para validar tel√©fono en tiempo real
        function validarTelefonoInput(input) {
            const telefonoFormateado = formatearTelefono(input.value);

            if (telefonoFormateado) {
                input.value = telefonoFormateado;
                input.style.borderColor = '#28a745'; // Verde para v√°lido
                input.style.backgroundColor = '#f8fff9';
                return true;
            } else if (input.value.trim() !== '') {
                input.style.borderColor = '#dc3545'; // Rojo para inv√°lido
                input.style.backgroundColor = '#fff5f5';
                return false;
            } else {
                // Campo vac√≠o
                input.style.borderColor = '';
                input.style.backgroundColor = '';
                return false;
            }
        }

        // Modificar la funci√≥n confirmarVenta para incluir validaci√≥n
        async function confirmarVenta() {
            const nombre = document.getElementById('nombreComprador').value.trim();
            const telefonoInput = document.getElementById('telefonoComprador');
            const telefonoRaw = telefonoInput.value.trim();

            if (!nombre) {
                mostrarNotificacion('‚ö†Ô∏è Ingresa el nombre del comprador', 'warning');
                document.getElementById('nombreComprador').focus();
                return;
            }

            if (!telefonoRaw) {
                mostrarNotificacion('‚ö†Ô∏è Ingresa el n√∫mero de tel√©fono', 'warning');
                telefonoInput.focus();
                return;
            }

            // Formatear y validar tel√©fono
            const telefonoFormateado = formatearTelefono(telefonoRaw);

            if (!telefonoFormateado) {
                mostrarNotificacion('‚ö†Ô∏è N√∫mero de tel√©fono inv√°lido. Debe tener 10 d√≠gitos y ser un celular colombiano (empezar con 3)', 'warning');
                telefonoInput.focus();
                telefonoInput.select();
                return;
            }

            // Actualizar el campo con el n√∫mero formateado
            telefonoInput.value = telefonoFormateado;
            const telefono = telefonoFormateado;

            // VALIDACI√ìN PARA RIFAS GRATUITAS (precio = 0)
            if (rifaData.precio === 0) {
                try {
                    const snapshot = await database.ref(`numerosGuardados/${telefono}`).once('value');

                    if (!snapshot.exists()) {
                        mostrarNotificacion('‚ö†Ô∏è Este n√∫mero no est√° autorizado para rifas gratuitas. Debe haber participado en rifas anteriores.', 'warning');
                        return;
                    }

                    const participanteAutorizado = snapshot.val();
                    mostrarNotificacion(`‚úÖ Participante autorizado: ${participanteAutorizado.nombre}`);

                } catch (error) {
                    console.error("Error al validar n√∫mero:", error);
                    mostrarNotificacion('‚ö†Ô∏è Error al validar el n√∫mero', 'warning');
                    return;
                }
            }

            // Proceder con la venta normal
            rifaData.numeros[numeroSeleccionado] = {
                estado: 'vendido',
                comprador: {
                    nombre: nombre,
                    telefono: telefono, // Usar el tel√©fono formateado
                    email: document.getElementById('emailComprador').value.trim(),
                    notas: document.getElementById('notasComprador').value.trim(),
                    fechaVenta: new Date().toLocaleString('es-CO', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                }
            };

            generarGrid();
            actualizarEstadisticas();
            cerrarModal();
            guardarRifaEnFirebase();

            mostrarNotificacion(`‚úÖ N√∫mero ${numeroSeleccionado.toString().padStart(2, '0')} vendido a ${nombre}!`);
        }

        function mostrarDetalles(numero) {
            const comprador = rifaData.numeros[numero].comprador;
            document.getElementById('numeroDetalles').textContent = numero.toString().padStart(2, '0');

            document.getElementById('infoComprador').innerHTML = `
      <div style="background: linear-gradient(135deg, #f8fff9, #e6ffed); padding: 25px; border-radius: 15px; margin-bottom: 25px; border: 2px solid #c3e6cb;">
        <p style="margin-bottom: 12px; font-size: 16px;"><strong>üë§ Nombre:</strong> ${comprador.nombre}</p>
        <p style="margin-bottom: 12px; font-size: 16px;"><strong>üì± Tel√©fono:</strong> <a href="https://wa.me/${comprador.telefono}" target="_blank" style="color: #28a745; text-decoration: none;">${comprador.telefono}</a></p>
        ${comprador.email ? `<p style="margin-bottom: 12px; font-size: 16px;"><strong>üìß Email:</strong> <a href="mailto:${comprador.email}" style="color: #28a745; text-decoration: none;">${comprador.email}</a></p>` : ''}
        <p style="margin-bottom: 12px; font-size: 16px;"><strong>üìÖ Fecha de venta:</strong> ${comprador.fechaVenta}</p>
        ${comprador.notas ? `<p style="margin-bottom: 12px; font-size: 16px;"><strong>üìù Notas:</strong> ${comprador.notas}</p>` : ''}
        <p style="margin-bottom: 0; font-size: 18px; font-weight: bold; color: #28a745;"><strong>üí∞ Valor pagado:</strong> $${rifaData.precio.toLocaleString('es-CO')}</p>
      </div>
    `;

            document.getElementById('btnLiberar').onclick = () => liberarNumero(numero);
            document.getElementById('detallesModal').style.display = 'block';
        }

        function liberarNumero(numero) {
            if (confirm(`¬øLiberar el n√∫mero ${numero.toString().padStart(2, '0')}?`)) {
                rifaData.numeros[numero] = {
                    estado: 'disponible',
                    comprador: null
                };

                generarGrid();
                actualizarEstadisticas();
                cerrarModalDetalles();
                guardarRifaEnFirebase();

                mostrarNotificacion(`‚úÖ N√∫mero ${numero.toString().padStart(2, '0')} liberado!`);
            }
        }

        function actualizarEstadisticas() {
            const vendidos = Object.values(rifaData.numeros).filter(n => n.estado === 'vendido').length;
            const disponibles = rifaData.totalNumeros - vendidos;
            const totalRecaudado = vendidos * rifaData.precio;
            const porcentaje = Math.round((vendidos / rifaData.totalNumeros) * 100);

            document.getElementById('totalNumerosDisplay').textContent = rifaData.totalNumeros;
            document.getElementById('numerosVendidos').textContent = vendidos;
            document.getElementById('numerosDisponibles').textContent = disponibles;
            document.getElementById('totalRecaudado').textContent = `$${totalRecaudado.toLocaleString('es-CO')}`;
            document.getElementById('porcentajeVentas').textContent = `${porcentaje}%`;
            document.getElementById('progressFill').style.width = `${porcentaje}%`;
        }

        // ================= FUNCIONES DE INTERFAZ =================

        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = mensaje;

            if (tipo === 'warning') {
                notification.style.background = 'linear-gradient(135deg, #fd7e14, #e83e8c)';
            }

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.5s ease reverse';
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 3000);
        }

        function cerrarModal() {
            document.getElementById('ventaModal').style.display = 'none';
        }

        function cerrarModalDetalles() {
            document.getElementById('detallesModal').style.display = 'none';
        }

        // ================= FUNCIONES DE EXPORTACI√ìN =================

        function exportarExcel() {
            // Tu implementaci√≥n actual de exportaci√≥n a Excel
            mostrarNotificacion('üìä Exportando a Excel... (funci√≥n por implementar)');
        }
        async function exportarPNG() {
            if (!rifaData.inicializada) {
                mostrarNotificacion('‚ö†Ô∏è Primero debes inicializar la rifa', 'warning');
                return;
            }

            // Verificar si html2canvas est√° cargado
            if (typeof html2canvas === 'undefined') {
                const loadingNotif = mostrarNotificacion('‚è≥ Cargando herramientas de exportaci√≥n...', 'warning');
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    if (loadingNotif && document.body.contains(loadingNotif)) {
                        document.body.removeChild(loadingNotif);
                    }
                } catch (error) {
                    console.error('Error al cargar html2canvas:', error);
                    mostrarNotificacion('‚ö†Ô∏è Error al cargar las herramientas de exportaci√≥n', 'warning');
                    return;
                }
            }

            // Mostrar loader
            const loader = document.createElement('div');
            loader.style.position = 'fixed';
            loader.style.top = '0';
            loader.style.left = '0';
            loader.style.width = '100%';
            loader.style.height = '100%';
            loader.style.backgroundColor = 'rgba(0,0,0,0.8)';
            loader.style.display = 'flex';
            loader.style.justifyContent = 'center';
            loader.style.alignItems = 'center';
            loader.style.zIndex = '9999';
            loader.innerHTML = `
        <div style="color: white; font-size: 28px; text-align: center; font-family: Arial, sans-serif;">
            üé® Generando imagen optimizada...<br>
            <div style="margin: 30px auto; width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid #38ef7d; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="font-size: 18px; margin-top: 20px; opacity: 0.8;">Creando versi√≥n perfecta...</p>
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    `;
            document.body.appendChild(loader);

            try {
                // Crear contenedor con dimensiones optimizadas
                const captureContainer = document.createElement('div');
                captureContainer.style.position = 'fixed';
                captureContainer.style.left = '0';
                captureContainer.style.top = '0';
                captureContainer.style.width = '1200px';
                captureContainer.style.padding = '50px';
                captureContainer.style.backgroundColor = '#ffffff';
                captureContainer.style.fontFamily = 'Arial, sans-serif';
                captureContainer.style.transform = 'translateX(-200%)';
                captureContainer.style.zIndex = '9998';
                captureContainer.style.position = 'relative'; // Para el posicionamiento de la marca de agua

                // MARCA DE AGUA DEL LOGO - Esquina superior izquierda
                const marcaDeAgua = document.createElement('div');
                marcaDeAgua.style.position = 'absolute';
                marcaDeAgua.style.top = '26%';
                marcaDeAgua.style.left = '5%';
                marcaDeAgua.style.zIndex = '1000';
                // marcaDeAgua.style.opacity = '0.3'; // Transparencia sutil
                marcaDeAgua.style.pointerEvents = 'none';
                marcaDeAgua.style.width = '150px';
                marcaDeAgua.style.height = '150px';
                marcaDeAgua.style.borderRadius = '50%';
                marcaDeAgua.style.overflow = 'hidden';
                marcaDeAgua.style.border = '3px solid rgba(255, 255, 255, 0.8)';
                marcaDeAgua.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
                marcaDeAgua.innerHTML = `
            <img src="./RIFASCOL.jpg" 
                 style="width: 100%; height: 100%; object-fit: cover;" 
                 alt="RIFASCOL Marca de Agua">
        `;
                captureContainer.appendChild(marcaDeAgua);

                // PREMIO + REGLAS COMBINADOS
                const premioSection = document.createElement('div');
                premioSection.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                premioSection.style.padding = '50px 40px';
                premioSection.style.borderRadius = '25px';
                premioSection.style.marginBottom = '40px';
                premioSection.style.textAlign = 'center';
                premioSection.style.border = '4px solid #f39c12';
                premioSection.style.boxShadow = '0 15px 40px rgba(243,156,18,0.3)';
                premioSection.style.position = 'relative';
                premioSection.style.overflow = 'hidden';
                premioSection.style.zIndex = '10'; // Asegurar que est√© por encima de la marca de agua

                // Obtener reglas
                const reglasInput = document.getElementById('reglasRifa').value.trim();
                const reglasTexto = reglasInput || 'Se aplicar√°n las reglas est√°ndar de la loter√≠a';

                // Contenido del premio + reglas
                premioSection.innerHTML = `
            <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); transform: rotate(45deg); animation: shine 3s infinite;"></div>
            
            <h2 style="font-size: 3.2em; color: #d35400; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); position: relative; z-index: 1; font-weight: bold;">üèÜ GANATE HASTA üèÜ</h2>
            
            <p style="font-size: 2.8em; color: #8b4513; font-weight: bold; margin-bottom: 15px; position: relative; z-index: 1; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${rifaData.premio || '¬°Premio Incre√≠ble!'}</p>
            
            <p style="font-size: 1.6em; line-height: 1.4; color: #8b4513; margin-bottom: 25px; font-weight: 600; white-space: pre-line;">${reglasTexto}</p>

            <p style="font-size: 2.2em; color: #d35400; font-weight: bold; position: relative; z-index: 1; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">üí∞ Precio: $${rifaData.precio.toLocaleString('es-CO')} üí∞</p>
            
        `;

                // INFORMACI√ìN DE LA RIFA - ORGANIZADA
                const infoSection = document.createElement('div');
                infoSection.style.padding = '40px';
                infoSection.style.background = 'linear-gradient(135deg, #e8f5e8, #f0fff4)';
                infoSection.style.borderRadius = '25px';
                infoSection.style.border = '4px solid #28a745';
                infoSection.style.boxShadow = '0 15px 40px rgba(40,167,69,0.2)';
                infoSection.style.marginBottom = '40px';
                infoSection.style.position = 'relative';
                infoSection.style.zIndex = '10';

                const vendidos = Object.values(rifaData.numeros).filter(n => n.estado === 'vendido').length;
                const disponibles = rifaData.totalNumeros - vendidos;
                const porcentajeVendidos = Math.round((vendidos / rifaData.totalNumeros) * 100);

                infoSection.innerHTML = `
            <h3 style="color: #155724; margin-bottom: 30px; font-size: 2.8em; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); font-weight: bold;">üìä INFORMACI√ìN DE LA RIFA</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; font-size: 1.8em; line-height: 1.3; color: #155724; font-weight: 600;">
                <div style="padding: 25px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 3px solid #28a745; text-align: center;">
                    <p style="margin-bottom: 10px; font-size: 1.1em; font-weight: bold;">üèõÔ∏è JUEGA CON</p>
                    <p style="color: #28a745; font-size: 1.2em;">${rifaData.nombreLoteria}</p>
                </div>
                
                <div style="padding: 25px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 3px solid #dc3545; text-align: center;">
                    <p style="margin-bottom: 10px; font-size: 1.1em; font-weight: bold;">üìÖ FECHA</p>
                    <p style="color: #dc3545; font-size: 1.2em;">${rifaData.fechaSorteo ? new Date(rifaData.fechaSorteo).toLocaleString('es-CO', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Por definir'}</p>
                </div>
                
                <div style="padding: 25px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 3px solid #007bff; text-align: center;">
                    <p style="margin-bottom: 10px; font-size: 1.1em; font-weight: bold;">üî¢ PROGRESO</p>
                    <p style="color: #007bff; font-size: 1.2em;">${vendidos}/${rifaData.totalNumeros} (${porcentajeVendidos}%)</p>
                </div>
                
                <div style="padding: 25px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 3px solid #28a745; text-align: center;">
                    <p style="margin-bottom: 10px; font-size: 1.1em; font-weight: bold;">‚úÖ DISPONIBLES</p>
                    <p style="color: #28a745; font-size: 1.4em; font-weight: bold;">${disponibles} n√∫meros</p>
                </div>
            </div>
        `;

                // GRILLA DE N√öMEROS - GRANDES Y SEGUROS
                const gridSection = document.createElement('div');
                gridSection.style.padding = '40px';
                gridSection.style.background = 'linear-gradient(135deg, #f8fff9, #e6ffed)';
                gridSection.style.borderRadius = '25px';
                gridSection.style.border = '4px solid #28a745';
                gridSection.style.boxShadow = '0 15px 40px rgba(0,0,0,0.15)';
                gridSection.style.marginBottom = '40px';
                gridSection.style.position = 'relative';
                gridSection.style.zIndex = '10';

                const tituloGrid = document.createElement('h2');
                tituloGrid.textContent = 'üé≤ N√öMEROS DE LA RIFA';
                tituloGrid.style.textAlign = 'center';
                tituloGrid.style.fontSize = '2.8em';
                tituloGrid.style.color = '#2d5016';
                tituloGrid.style.marginBottom = '30px';
                tituloGrid.style.textShadow = '2px 2px 4px rgba(0,0,0,0.2)';
                tituloGrid.style.fontWeight = 'bold';

                // Leyenda visible
                const leyenda = document.createElement('div');
                leyenda.style.display = 'flex';
                leyenda.style.justifyContent = 'center';
                leyenda.style.gap = '40px';
                leyenda.style.marginBottom = '30px';
                leyenda.style.fontSize = '1.6em';
                leyenda.style.fontWeight = 'bold';

                leyenda.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px; background: white; padding: 15px 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 3px solid #28a745;">
                <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 8px; border: 2px solid #28a745;"></div>
                <span style="color: #155724;">DISPONIBLE</span>
            </div>
            <div style="display: flex; align-items: center; gap: 15px; background: white; padding: 15px 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 3px solid #11998e;">
                <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #11998e, #38ef7d); border-radius: 8px;"></div>
                <span style="color: #11998e;">VENDIDO</span>
            </div>
        `;

                // Grid de n√∫meros m√°s grande
                const gridContainer = document.createElement('div');
                gridContainer.style.display = 'grid';
                gridContainer.style.gridTemplateColumns = 'repeat(10, 1fr)';
                gridContainer.style.gap = '15px';
                gridContainer.style.padding = '5px';
                gridContainer.style.background = 'white';
                gridContainer.style.borderRadius = '20px';
                gridContainer.style.boxShadow = 'none';

                // Generar n√∫meros m√°s grandes y atractivos
                for (let i = 0; i < rifaData.totalNumeros; i++) {
                    const numeroDiv = document.createElement('div');
                    numeroDiv.textContent = i.toString().padStart(2, '0');
                    numeroDiv.style.width = '80px';
                    numeroDiv.style.height = '80px';
                    numeroDiv.style.display = 'flex';
                    numeroDiv.style.alignItems = 'center';
                    numeroDiv.style.justifyContent = 'center';
                    numeroDiv.style.borderRadius = '15px';
                    numeroDiv.style.fontWeight = 'bold';
                    numeroDiv.style.fontSize = '1.8em';
                    numeroDiv.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                    numeroDiv.style.border = '3px solid';

                    if (rifaData.numeros[i].estado === 'disponible') {
                        numeroDiv.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
                        numeroDiv.style.color = '#155724';
                        numeroDiv.style.borderColor = '#28a745';
                    } else {
                        numeroDiv.style.background = 'linear-gradient(135deg, #11998e, #38ef7d)';
                        numeroDiv.style.color = 'white';
                        numeroDiv.style.borderColor = '#0d6efd';
                    }

                    gridContainer.appendChild(numeroDiv);
                }

                gridSection.appendChild(tituloGrid);
                gridSection.appendChild(leyenda);
                gridSection.appendChild(gridContainer);

                // Ensamblar todo (la marca de agua ya est√° agregada al principio)
                captureContainer.appendChild(infoSection);
                captureContainer.appendChild(premioSection);
                captureContainer.appendChild(gridSection);

                document.body.appendChild(captureContainer);

                // Animaci√≥n
                const style = document.createElement('style');
                style.textContent = `
            @keyframes shine {
                0% { transform: translateX(-200%) rotate(45deg); }
                100% { transform: translateX(200%) rotate(45deg); }
            }
        `;
                document.head.appendChild(style);

                // Esperar un momento para que se renderice
                await new Promise(resolve => setTimeout(resolve, 500));

                // Capturar con configuraci√≥n segura
                const canvas = await html2canvas(captureContainer, {
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: 1200,
                    windowHeight: captureContainer.scrollHeight,
                    onclone: (clonedDoc) => {
                        const clonedStyle = clonedDoc.createElement('style');
                        clonedStyle.textContent = style.textContent;
                        clonedDoc.head.appendChild(clonedStyle);
                    }
                });

                // Verificar que el canvas sea v√°lido
                if (!canvas || canvas.width === 0 || canvas.height === 0) {
                    throw new Error('El canvas generado no es v√°lido');
                }

                // Descargar con compresi√≥n segura
                const image = canvas.toDataURL('image/png', 0.95);

                // Verificar que la imagen se gener√≥ correctamente
                if (!image || image === 'data:,') {
                    throw new Error('Error al generar la imagen');
                }

                const link = document.createElement('a');
                link.href = image;

                const fechaActual = new Date().toISOString().split('T')[0];
                const nombreArchivo = `RIFASCOL_${rifaData.nombreLoteria.replace(/[^a-zA-Z0-9]/g, '_')}_${fechaActual}_HD.png`;

                link.download = nombreArchivo;
                link.click();

                // Limpiar
                document.body.removeChild(captureContainer);
                document.body.removeChild(loader);
                document.head.removeChild(style);

                mostrarNotificacion('‚úÖ ¬°Imagen HD generada correctamente con marca de agua RIFASCOL! üì±üéØ');

            } catch (error) {
                console.error('Error al generar PNG:', error);
                if (document.body.contains(loader)) {
                    document.body.removeChild(loader);
                }
                mostrarNotificacion('‚ö†Ô∏è Error al generar la imagen: ' + error.message, 'warning');
            }
        }

        // ================= EVENTOS GLOBALES =================

        window.onclick = function (event) {
            if (event.target === document.getElementById('ventaModal')) {
                cerrarModal();
            }
            if (event.target === document.getElementById('detallesModal')) {
                cerrarModalDetalles();
            }
        };

        window.addEventListener('beforeunload', function (e) {
            if (rifaData.inicializada) {
                e.preventDefault();
                return '‚ö†Ô∏è Tienes una rifa activa. ¬øEst√°s seguro de salir?';
            }
        });

        // Mostrar modal del ganador
        function mostrarModalGanador() {
            if (!rifaData.inicializada) {
                mostrarNotificacion('‚ö†Ô∏è Primero debes inicializar una rifa', 'warning');
                return;
            }

            document.getElementById('numeroGanador').value = '';
            document.getElementById('valorPremio').value = '';
            document.getElementById('comprobantePago').value = '';
            document.getElementById('previewPlantilla').style.display = 'none';
            document.getElementById('ganadorModal').style.display = 'block';
        }

        // Cerrar modal del ganador
        function cerrarModalGanador() {
            document.getElementById('ganadorModal').style.display = 'none';
        }

        // Generar plantilla del ganador
        function generarPlantillaGanador() {
            const numeroGanador = parseInt(document.getElementById('numeroGanador').value);
            const valorPremio = document.getElementById('valorPremio').value.trim();
            const numeroLoteria = document.getElementById('numeroLoteriaJugado').value.trim();
            const comprobanteInput = document.getElementById('comprobantePago');

            // Validaciones
            if (isNaN(numeroGanador)) {
                mostrarNotificacion('‚ö†Ô∏è Ingresa un n√∫mero ganador v√°lido (00-99)', 'warning');
                return;
            }

            if (!rifaData.numeros[numeroGanador] || rifaData.numeros[numeroGanador].estado !== 'vendido') {
                mostrarNotificacion(`‚ö†Ô∏è El n√∫mero ${numeroGanador.toString().padStart(2, '0')} no est√° vendido`, 'warning');
                return;
            }

            if (!valorPremio) {
                mostrarNotificacion('‚ö†Ô∏è Ingresa el valor del premio', 'warning');
                return;
            }

            if (!numeroLoteria) {
                mostrarNotificacion('‚ö†Ô∏è Ingresa el numero de la loteria Jugado.', 'warning');
                return;
            }

            // Obtener datos del ganador
            const ganador = rifaData.numeros[numeroGanador].comprador;

            // Crear plantilla HTML
            const plantilla = document.getElementById('plantillaGanador');
            plantilla.innerHTML = `
        <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 30px; border-radius: 15px; margin-bottom: 20px;">
            <h1 style="color: #28a745; margin-bottom: 20px;">¬°FELICITACIONES!</h1>
            <p style="font-size: 20px; margin-bottom: 15px;">${ganador.nombre}</p>
            <p style="font-size: 18px; margin-bottom: 25px;">Has ganado el premio de <strong>${valorPremio}</strong></p>
            
            <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 16px;">N√∫mero Jugado ${rifaData.nombreLoteria}:</p>
                <p style="font-size: 36px; font-weight: bold; color: #28a745; margin: 5px 0;">${numeroLoteria}</p>
                <p style="margin: 0; font-size: 16px;">N√∫mero ganador:</p>
                <p style="font-size: 36px; font-weight: bold; color: #28a745; margin: 5px 0;">${numeroGanador.toString().padStart(2, '0')}</p>
            </div>
            
            ${comprobanteInput.files[0] ? `
                <div style="margin-top: 20px;">
                    <p style="font-size: 16px; margin-bottom: 10px;">Comprobante de pago:</p>
                    <img id="previewComprobante" src="#" alt="Comprobante" style="max-width: 100%; border-radius: 10px; border: 2px solid #ddd;">
                </div>
            ` : ''}
            
            <p style="margin-top: 30px; font-size: 14px; color: #6c757d;">
                ${rifaData.nombreLoteria || 'Loter√≠a'} - ${new Date().toLocaleDateString('es-CO')}
            </p>
            </br>
            <p>manejo de rifas - ¬©RIFASCOL</p>
        </div>
    `;

            // Mostrar comprobante si se subi√≥
            if (comprobanteInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('previewComprobante').src = e.target.result;
                };
                reader.readAsDataURL(comprobanteInput.files[0]);
            }

            // Mostrar previsualizaci√≥n
            document.getElementById('previewPlantilla').style.display = 'block';
        }

        async function exportarPlantillaPNG() {
            if (!rifaData.inicializada) {
                mostrarNotificacion('‚ö†Ô∏è Primero debes inicializar la rifa', 'warning');
                return;
            }

            // Verificar si html2canvas est√° cargado
            if (typeof html2canvas === 'undefined') {
                const loadingNotif = mostrarNotificacion('‚è≥ Cargando herramientas de exportaci√≥n...', 'warning');

                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });

                    if (loadingNotif && document.body.contains(loadingNotif)) {
                        document.body.removeChild(loadingNotif);
                    }
                } catch (error) {
                    console.error('Error al cargar html2canvas:', error);
                    mostrarNotificacion('‚ö†Ô∏è Error al cargar las herramientas de exportaci√≥n', 'warning');
                    return;
                }
            }

            // Mostrar loader
            const loader = document.createElement('div');
            loader.style.position = 'fixed';
            loader.style.top = '0';
            loader.style.left = '0';
            loader.style.width = '100%';
            loader.style.height = '100%';
            loader.style.backgroundColor = 'rgba(0,0,0,0.7)';
            loader.style.display = 'flex';
            loader.style.justifyContent = 'center';
            loader.style.alignItems = 'center';
            loader.style.zIndex = '9999';
            loader.innerHTML = `
        <div style="color: white; font-size: 24px; text-align: center;">
            Generando imagen...<br>
            <div style="margin: 20px auto; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #38ef7d; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    `;
            document.body.appendChild(loader);

            try {
                // Crear un contenedor especial para la captura
                const captureContainer = document.createElement('div');
                captureContainer.style.position = 'fixed';
                captureContainer.style.left = '0';
                captureContainer.style.top = '0';
                captureContainer.style.width = '600px'; // Ancho m√°s adecuado para la plantilla
                captureContainer.style.padding = '20px';
                captureContainer.style.backgroundColor = 'white';
                captureContainer.style.borderRadius = '20px';
                captureContainer.style.boxShadow = '0 0 20px rgba(0,0,0,0.2)';
                captureContainer.style.transform = 'translateX(-200%)';
                captureContainer.style.zIndex = '9998';

                // Clonar la plantilla del ganador
                const plantillaClone = document.getElementById('plantillaGanador').cloneNode(true);

                // Asegurar estilos de texto en el clon
                plantillaClone.style.fontFamily = 'Arial, sans-serif';
                plantillaClone.style.letterSpacing = 'normal';
                plantillaClone.style.wordSpacing = 'normal';
                plantillaClone.querySelectorAll('*').forEach(el => {
                    el.style.fontFamily = 'Arial, sans-serif';
                    el.style.letterSpacing = 'normal';
                    el.style.wordSpacing = 'normal';
                });

                // Agregar al contenedor
                captureContainer.appendChild(plantillaClone);
                document.body.appendChild(captureContainer);

                // Usar html2canvas con la misma configuraci√≥n que funciona
                const canvas = await html2canvas(captureContainer, {
                    scale: 2,
                    logging: true,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff', // Fondo blanco s√≥lido
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: captureContainer.scrollWidth,
                    windowHeight: captureContainer.scrollHeight,
                    letterRendering: 1 // Renderizado mejorado de texto
                });

                // Convertir a imagen y descargar
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = image;

                const numeroGanador = document.getElementById('numeroGanador').value;
                const nombreGanador = rifaData.numeros[numeroGanador]?.comprador?.nombre || 'ganador';
                const nombreArchivo = `Felicidades_${nombreGanador.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;

                link.download = nombreArchivo;
                document.body.appendChild(link);
                link.click();

                // Limpiar
                document.body.removeChild(captureContainer);
                document.body.removeChild(link);
                document.body.removeChild(loader);

                mostrarNotificacion('üéâ Plantilla del ganador exportada exitosamente!');
                cerrarModalGanador();
            } catch (error) {
                console.error('Error al generar PNG:', error);
                document.body.removeChild(loader);
                mostrarNotificacion('‚ö†Ô∏è Error al generar la imagen: ' + error.message, 'warning');
            }
        }

        function ajustarModalGanador() {
            const modal = document.getElementById('ganadorModal');
            const content = modal.querySelector('.modal-content');

            // Ajustar altura m√°xima seg√∫n la pantalla
            content.style.maxHeight = `${window.innerHeight * 0.9}px`;

            // Asegurar que el scroll funcione correctamente
            const scrollContainer = content.querySelector('div');
            scrollContainer.style.maxHeight = `${window.innerHeight * 0.9 - 100}px`;
        }

        // Llamar esta funci√≥n al abrir el modal
        function mostrarModalGanador() {
            document.getElementById('ganadorModal').style.display = 'block';
            ajustarModalGanador();
        }

        async function guardarNumeros() {
            if (!rifaData.inicializada) {
                mostrarNotificacion('‚ö†Ô∏è Primero debes inicializar la rifa', 'warning');
                return;
            }

            if (!confirm('¬øConfirmas guardar todos los n√∫meros de tel√©fono de esta rifa?')) {
                return;
            }

            try {
                // Obtener todos los tel√©fonos de n√∫meros vendidos
                const telefonosVendidos = [];
                Object.values(rifaData.numeros).forEach(numero => {
                    if (numero.estado === 'vendido' && numero.comprador && numero.comprador.telefono) {
                        telefonosVendidos.push({
                            telefono: numero.comprador.telefono,
                            nombre: numero.comprador.nombre,
                            fechaGuardado: new Date().toISOString()
                        });
                    }
                });

                if (telefonosVendidos.length === 0) {
                    mostrarNotificacion('‚ö†Ô∏è No hay n√∫meros vendidos para guardar', 'warning');
                    return;
                }

                // Guardar en Firebase bajo una nueva colecci√≥n
                const updates = {};
                telefonosVendidos.forEach(item => {
                    updates[`numerosGuardados/${item.telefono}`] = item;
                });

                await database.ref().update(updates);

                mostrarNotificacion(`‚úÖ ${telefonosVendidos.length} n√∫meros de tel√©fono guardados correctamente`);

            } catch (error) {
                console.error("Error al guardar n√∫meros:", error);
                mostrarNotificacion('‚ö†Ô∏è Error al guardar los n√∫meros', 'warning');
            }
        }

        async function limpiarNumerosGuardados() {
            try {
                await database.ref('numerosGuardados').remove();
                mostrarNotificacion('üîÑ N√∫meros guardados reiniciados correctamente');
            } catch (error) {
                console.error("Error al limpiar n√∫meros guardados:", error);
                mostrarNotificacion('‚ö†Ô∏è Error al reiniciar n√∫meros guardados', 'warning');
            }
        }

        // 5. Funci√≥n para verificar y ejecutar reinicio semanal autom√°tico
        function verificarReinicioSemanal() {
            const ahora = new Date();
            const esLunes = ahora.getDay() === 1; // 1 = Lunes
            const esMedianoche = ahora.getHours() === 0 && ahora.getMinutes() === 0;

            if (esLunes && esMedianoche) {
                limpiarNumerosGuardados();
            }
        }

        // 6. Inicializar verificaci√≥n de reinicio cada minuto
        setInterval(verificarReinicioSemanal, 60000);

        // 7. Funci√≥n para ver n√∫meros guardados (opcional para administraci√≥n)
        async function verNumerosGuardados() {
            try {
                const snapshot = await database.ref('numerosGuardados').once('value');
                const numerosGuardados = snapshot.val();

                if (!numerosGuardados) {
                    mostrarNotificacion('üìù No hay n√∫meros guardados actualmente', 'info');
                    return;
                }

                const totalNumeros = Object.keys(numerosGuardados).length;
                console.log('N√∫meros guardados:', numerosGuardados);
                mostrarNotificacion(`üìä Total de n√∫meros guardados: ${totalNumeros}`);

            } catch (error) {
                console.error("Error al consultar n√∫meros guardados:", error);
                mostrarNotificacion('‚ö†Ô∏è Error al consultar n√∫meros guardados', 'warning');
            }
        }

        // Tambi√©n al redimensionar la ventana
        window.addEventListener('resize', ajustarModalGanador);
    </script>
</body>

</html>